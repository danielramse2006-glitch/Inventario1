<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"><title>Actualizar - Inventario</title>
    <link rel="stylesheet" href="style.css">
    <style>body { background-color: #f0f0f0; }</style>
</head>
<body>
    <h2 style="text-align:center; background:#2c3e50; color:white; padding:15px; margin:0;">Actualizar Material Existente</h2>
    
    <div style="text-align:center; padding:20px; background:#ddd;">
        <input type="text" id="busqueda" placeholder="Ingrese No. de Parte..." style="padding:10px; width:250px;">
        <button id="btnBuscar" class="btn-action" style="background:#3498db; color:white;">BUSCAR</button>
    </div>

    <form id="form-upd" class="grid-form" style="padding-top:10px;">
        <div class="col">
            <label>Modelo</label><input type="text" id="m">
            <label>No. Parte</label><input type="text" id="np">
            <label>Nombre</label><input type="text" id="n">
            <label>Cantidad</label><input type="number" id="c">
        </div>
        <div class="col">
            <p>Categorías:</p>
            <label><input type="checkbox" id="t_c"> Consumible</label><br>
            <label><input type="checkbox" id="t_p"> Pieza</label><br>
            <label><input type="checkbox" id="t_h"> Herramienta</label><br>
            <label><input type="checkbox" id="t_e"> Equipo</label>
        </div>
        <div class="col">
            <label>Laboratorio</label><input type="text" id="lab">
            <label>Rack</label><input type="text" id="rac">
            <label>Contenedor</label><input type="text" id="cnt">
        </div>
        <div class="col">
            <label>Costo</label><input type="number" id="co">
            <label>Observaciones</label><textarea id="ob"></textarea>
        </div>

        <div class="form-buttons" style="grid-column: span 4; text-align:center; margin-top:20px;">
            <button type="submit" class="btn-action" style="background:#e67e22; color:white;">GUARDAR CAMBIOS</button>
            <button type="button" class="btn-action" onclick="location.href='index.html'">CANCELAR</button>
        </div>
    </form>

    <script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, query, where, getDocs, doc, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const user = checkAuth('actualizar');
        let docId = null;
        let datosOriginales = null;

        document.getElementById('btnBuscar').onclick = async () => {
            const val = document.getElementById('busqueda').value.trim();
            const q = query(collection(db, "productos"), where("noParte", "==", val));
            const snap = await getDocs(q);

            if(!snap.empty) {
                const d = snap.docs[0].data();
                docId = snap.docs[0].id;
                datosOriginales = {...d}; // Guardar datos originales
                
                document.getElementById('m').value = d.modelo || '';
                document.getElementById('np').value = d.noParte || '';
                document.getElementById('n').value = d.nombre || '';
                document.getElementById('c').value = d.cantidad || 0;
                document.getElementById('co').value = d.costo || 0;
                document.getElementById('ob').value = d.observaciones || '';
                document.getElementById('lab').value = d.laboratorio || '';
                document.getElementById('rac').value = d.rack || '';
                document.getElementById('cnt').value = d.contenedor || '';
                document.getElementById('t_c').checked = d.consumible || false;
                document.getElementById('t_p').checked = d.pieza || false;
                document.getElementById('t_h').checked = d.herramienta || false;
                document.getElementById('t_e').checked = d.equipo || false;
                alert("✓ Datos cargados.");
            } else { alert("Material no encontrado."); }
        };

        document.getElementById('form-upd').onsubmit = async (e) => {
            e.preventDefault();
            if(!docId) return alert("Primero busque un producto.");

            const datosNuevos = {
                modelo: document.getElementById('m').value,
                noParte: document.getElementById('np').value,
                nombre: document.getElementById('n').value,
                cantidad: Number(document.getElementById('c').value),
                costo: Number(document.getElementById('co').value),
                observaciones: document.getElementById('ob').value,
                laboratorio: document.getElementById('lab').value,
                rack: document.getElementById('rac').value,
                contenedor: document.getElementById('cnt').value,
                consumible: document.getElementById('t_c').checked,
                pieza: document.getElementById('t_p').checked,
                herramienta: document.getElementById('t_h').checked,
                equipo: document.getElementById('t_e').checked
            };

            // Actualizar producto
            await updateDoc(doc(db, "productos", docId), datosNuevos);

            // REGISTRAR MOVIMIENTO DE ACTUALIZACIÓN
            await addDoc(collection(db, "movimientos"), {
                tipo: "ACTUALIZACIÓN",
                fecha: serverTimestamp(),
                usuario: user.usuario,
                productos: [{
                    id: docId,
                    modelo: datosNuevos.modelo,
                    noParte: datosNuevos.noParte,
                    nombre: datosNuevos.nombre,
                    cantidadAnterior: datosOriginales.cantidad,
                    cantidadNueva: datosNuevos.cantidad
                }],
                cambios: {
                    antes: datosOriginales,
                    despues: datosNuevos
                }
            });
            
            alert("✓ Cambios guardados y registrados en movimientos.");
            location.href = 'index.html';
        };
    </script>
</body>
</html>
